{% extends "base.html" %}

{% block content %}
<section class="transactions-header">
  <div>
    <p class="eyebrow">Transactions</p>
    <h1>Browse and manage entries.</h1>
    <p class="subhead">Search, edit, or delete any transaction.</p>
  </div>
  <form class="search-form" method="get" action="{{ url_for('transactions') }}">
    <input type="text" name="q" placeholder="Search description, category, type, date..." value="{{ query }}" />
    <div class="filters">
      <label>
        Type
        <select name="type">
          <option value="">All</option>
          <option value="income" {% if selected_type == 'income' %}selected{% endif %}>Income</option>
          <option value="spending" {% if selected_type == 'spending' %}selected{% endif %}>Spending</option>
        </select>
      </label>
      <label>
        Category
        <select name="category">
          <option value="">All</option>
          <optgroup label="Income">
            {% for category in income_categories %}
              <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category.replace('_', ' ').title() }}</option>
            {% endfor %}
          </optgroup>
          <optgroup label="Spending">
            {% for category in spending_categories %}
              <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category.replace('_', ' ').title() }}</option>
            {% endfor %}
          </optgroup>
        </select>
      </label>
    </div>
    <button type="submit">Search</button>
  </form>
</section>

<section class="transactions-list">
  <div class="list-header">
    <span>{{ total }} result{% if total != 1 %}s{% endif %}</span>
    <span class="muted">Page {{ page }} of {{ total_pages }}</span>
  </div>

  {% for row in rows %}
    <div class="transaction-row">
      <div>
        <span class="tag {{ row.type }}">{{ row.type }}</span>
        <strong>${{ row.amount|currency }}</strong>
        <span class="muted">{{ row.category.replace('_', ' ').title() }}</span>
      </div>
      <div class="muted">{{ row.description }}</div>
      <div class="transaction-meta">
        <span class="date">{{ row.date }}</span>
        <div class="actions">
          <button
            type="button"
            class="button-link edit-button"
            data-id="{{ row.id }}"
            data-amount="{{ row.amount }}"
            data-type="{{ row.type }}"
            data-category="{{ row.category }}"
            data-description="{{ row.description }}"
            data-date="{{ row.date }}"
          >
            Edit
          </button>
          <form method="post" action="{{ url_for('remove_transaction', tx_id=row.id) }}" onsubmit="return confirm('Delete this transaction?');">
            <button type="submit" class="danger">Delete</button>
          </form>
        </div>
      </div>
    </div>
  {% else %}
    <p class="muted">No transactions found.</p>
  {% endfor %}

  <div class="pagination">
    {% if page > 1 %}
      <a href="{{ url_for('transactions', q=query, category=selected_category, type=selected_type, page=page-1) }}">Previous</a>
    {% endif %}
    {% for p in pages %}
      {% if p %}
        <a class="{% if p == page %}active{% endif %}" href="{{ url_for('transactions', q=query, category=selected_category, type=selected_type, page=p) }}">{{ p }}</a>
      {% else %}
        <span class="ellipsis">â€¦</span>
      {% endif %}
    {% endfor %}
    {% if page < total_pages %}
      <a href="{{ url_for('transactions', q=query, category=selected_category, type=selected_type, page=page+1) }}">Next</a>
    {% endif %}
  </div>
</section>

<div class="modal" id="edit-modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <h3>Edit transaction</h3>
        <p class="muted">Update the entry and save changes.</p>
      </div>
      <button type="button" class="close" data-close="true">Close</button>
    </div>
    <div class="modal-body">
      <form class="form" id="edit-form" method="post">
        <label>
          Amount
          <input type="number" name="amount" step="0.01" min="0" required />
        </label>

        <div class="toggle">
          <label>
            <input type="radio" name="type" value="income" required />
            <span>Income</span>
          </label>
          <label>
            <input type="radio" name="type" value="spending" required />
            <span>Spending</span>
          </label>
        </div>

        <label>
          Category
          <select name="category" required>
            <optgroup label="Income">
              {% for category in income_categories %}
                <option value="{{ category }}">{{ category.replace('_', ' ').title() }}</option>
              {% endfor %}
            </optgroup>
            <optgroup label="Spending">
              {% for category in spending_categories %}
                <option value="{{ category }}">{{ category.replace('_', ' ').title() }}</option>
              {% endfor %}
            </optgroup>
          </select>
        </label>

        <label>
          Description
          <input type="text" name="description" />
        </label>

        <label>
          Date
          <input type="date" name="date" />
        </label>

        <button type="submit">Save Changes</button>
      </form>
    </div>
  </div>
</div>

<script>
  const editModal = document.getElementById("edit-modal");
  const editForm = document.getElementById("edit-form");

  const openEditModal = (button) => {
    const txId = button.dataset.id;
    editForm.action = `/transactions/${txId}/edit`;
    editForm.amount.value = button.dataset.amount;
    editForm.description.value = button.dataset.description || "";
    editForm.date.value = button.dataset.date || "";

    const type = button.dataset.type;
    editForm.querySelectorAll("input[name='type']").forEach((input) => {
      input.checked = input.value === type;
    });

    const category = button.dataset.category;
    editForm.category.value = category;

    editModal.classList.add("open");
    editModal.setAttribute("aria-hidden", "false");
  };

  document.addEventListener("click", (event) => {
    const target = event.target.closest(".edit-button");
    if (target) {
      event.preventDefault();
      openEditModal(target);
      return;
    }

    if (event.target.dataset.close === "true") {
      editModal.classList.remove("open");
      editModal.setAttribute("aria-hidden", "true");
    }
  });
</script>
{% endblock %}
