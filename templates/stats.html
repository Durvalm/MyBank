{% extends "base.html" %}

{% block content %}
<section class="stats-hero">
  <div>
    <p class="eyebrow">Overview</p>
    <h1>Money at a glance.</h1>
    <p class="subhead">Totals and recent activity pulled straight from your live database.</p>
  </div>
  <div class="toggle-privacy">
    <label class="switch">
      <input type="checkbox" id="show-values-toggle" />
      <span class="slider"></span>
    </label>
    <span>Show values</span>
  </div>
  <div class="totals">
    <div class="total-card">
      <span>All-time income</span>
      <strong class="stat-value">${{ all_time.income|currency }}</strong>
    </div>
    <div class="total-card">
      <span>All-time spending</span>
      <strong class="stat-value">${{ all_time.spending|currency }}</strong>
    </div>
  </div>
</section>

<section class="periods">
  {% for item in periods %}
    <div class="period-card">
      <h3>Last {{ item.days // 30 }} months</h3>
      <div class="period-values">
        <span>Income: <strong class="stat-value">${{ item.totals.income|currency }}</strong></span>
        <span>Spending: <strong class="stat-value">${{ item.totals.spending|currency }}</strong></span>
      </div>
    </div>
  {% endfor %}
</section>

<section class="monthly">
  <div class="section-header">
    <div>
      <h2>Monthly snapshot</h2>
      <p class="muted">Income, spending, and category totals for a selected month.</p>
    </div>
    <form method="get" action="{{ url_for('stats') }}" class="month-picker">
      <label>
        Month
        <select name="month" onchange="this.form.submit()">
          {% for month in available_months %}
            <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>{{ month }}</option>
          {% endfor %}
        </select>
      </label>
    </form>
  </div>

  {% if available_months %}
    <div class="totals monthly-totals">
      <button
        type="button"
        class="total-card clickable"
        data-month="{{ selected_month }}"
        data-type="income"
      >
        <span>Income</span>
        <strong>${{ monthly_by_type.income|currency }}</strong>
      </button>
      <button
        type="button"
        class="total-card clickable"
        data-month="{{ selected_month }}"
        data-type="spending"
      >
        <span>Spending</span>
        <strong>${{ monthly_by_type.spending|currency }}</strong>
      </button>
    </div>

    <div class="category-grid">
      <div class="category-card">
        <h3>Income by category</h3>
        <div class="category-list">
          {% for item in category_breakdown.income %}
            <button
              type="button"
              class="category-row clickable"
              data-month="{{ selected_month }}"
              data-type="income"
              data-category="{{ item.category }}"
            >
              <span>{{ item.category.replace('_', ' ').title() }}</span>
              <strong>${{ item.total|currency }}</strong>
            </button>
          {% else %}
            <p class="muted">No income entries for this month.</p>
          {% endfor %}
        </div>
      </div>
      <div class="category-card">
        <h3>Spending by category</h3>
        <div class="category-list">
          {% for item in category_breakdown.spending %}
            <button
              type="button"
              class="category-row clickable"
              data-month="{{ selected_month }}"
              data-type="spending"
              data-category="{{ item.category }}"
            >
              <span>{{ item.category.replace('_', ' ').title() }}</span>
              <strong>${{ item.total|currency }}</strong>
            </button>
          {% else %}
            <p class="muted">No spending entries for this month.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  {% else %}
    <p class="muted">No monthly data yet.</p>
  {% endif %}
</section>

<section class="recent">
  <div class="recent-header">
    <h2>Recent transactions</h2>
    <p>Showing the latest 5 entries. <a href="{{ url_for('transactions') }}">View all</a></p>
  </div>
  <div class="recent-list">
    {% for row in recent %}
      <div class="recent-item">
        <div>
          <span class="tag {{ row.type }}">{{ row.type }}</span>
          <strong>${{ row.amount|currency }}</strong>
          <span class="muted">{{ row.category.replace('_', ' ').title() }}</span>
        </div>
        <div class="muted">{{ row.description }}</div>
        <div class="date">{{ row.date }}</div>
      </div>
    {% else %}
      <p class="muted">No transactions yet.</p>
    {% endfor %}
  </div>
</section>

<div class="modal" id="tx-modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <h3 id="modal-title">Transactions</h3>
        <p id="modal-subtitle" class="muted"></p>
      </div>
      <button type="button" class="close" data-close="true">Close</button>
    </div>
    <div class="modal-body" id="modal-body">
      <p class="muted">Loading...</p>
    </div>
  </div>
</div>

<script>
  const toggle = document.getElementById("show-values-toggle");
  const root = document.documentElement;

  const applyPrivacy = (isVisible) => {
    if (isVisible) {
      root.classList.remove("blur-values");
    } else {
      root.classList.add("blur-values");
    }
  };

  const saved = localStorage.getItem("mybank-show-values");
  const initial = saved === null ? false : saved === "true";
  toggle.checked = initial;
  applyPrivacy(initial);

  toggle.addEventListener("change", () => {
    localStorage.setItem("mybank-show-values", toggle.checked);
    applyPrivacy(toggle.checked);
  });

  const modal = document.getElementById("tx-modal");
  const modalBody = document.getElementById("modal-body");
  const modalTitle = document.getElementById("modal-title");
  const modalSubtitle = document.getElementById("modal-subtitle");

  const formatCurrency = (value) => {
    const num = Number(value || 0);
    return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  const openModal = async (button) => {
    const month = button.dataset.month || "";
    const type = button.dataset.type || "";
    const category = button.dataset.category || "";

    modalBody.innerHTML = "<p class=\"muted\">Loading...</p>";
    modalTitle.textContent = "Transactions";
    modalSubtitle.textContent = [
      month ? `Month: ${month}` : null,
      type ? `Type: ${type}` : null,
      category ? `Category: ${category.replace(/_/g, " ")}` : null,
    ].filter(Boolean).join(" â€¢ ");

    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");

    const params = new URLSearchParams();
    if (month) params.set("month", month);
    if (type) params.set("type", type);
    if (category) params.set("category", category);

    let rows = [];
    try {
      const response = await fetch(`/transactions/filter?${params.toString()}`);
      rows = await response.json();
    } catch (error) {
      modalBody.innerHTML = "<p class=\"muted\">Unable to load transactions.</p>";
      return;
    }

    if (!rows.length) {
      modalBody.innerHTML = "<p class=\"muted\">No transactions found.</p>";
    } else {
      modalBody.innerHTML = rows.map((row) => `
        <div class="modal-row">
          <div>
            <span class="tag ${row.type}">${row.type}</span>
            <strong>$${formatCurrency(row.amount)}</strong>
            <span class="muted">${row.category.replace(/_/g, " ")}</span>
          </div>
          <div class="muted">${row.description}</div>
          <div class="date">${row.date}</div>
        </div>
      `).join("");
    }

  };

  document.addEventListener("click", (event) => {
    const button = event.target.closest(".clickable");
    if (!button) return;
    event.preventDefault();
    openModal(button);
  });

  modal.addEventListener("click", (event) => {
    if (event.target.dataset.close === "true") {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
    }
  });
</script>
{% endblock %}
